---
import BaseLayout from '@/layouts/BaseLayout.astro';
import TracingBeam from '@/components/TracingBeam';
import Scene3D from '@/components/Scene3D';
import { getCollection } from 'astro:content';

const chats = await getCollection('chats');
const plans = await getCollection('plans');

const chatEntries = chats.map((chat) => ({
  title: chat.data.title,
  date: chat.data.date.toISOString(),
  slug: chat.id.replace(/\.mdx?$/, ''),
  tags: chat.data.tags,
  tldr: chat.data.tldr,
  actionItems: chat.data.action_items,
  type: 'chat' as const,
  href: `/chats/${chat.id.replace(/\.mdx?$/, '')}`,
}));

const planEntries = plans.map((plan) => ({
  title: plan.data.title,
  date: plan.data.date.toISOString(),
  slug: plan.id.replace(/\.mdx?$/, ''),
  tags: plan.data.tags,
  tldr: plan.data.tldr,
  actionItems: (plan.data.milestones || []).map((m) => ({ task: m.title, done: m.status === 'complete' })),
  type: 'plan' as const,
  href: `/plans/${plan.id.replace(/\.mdx?$/, '')}`,
}));

const entries = [...chatEntries, ...planEntries].sort(
  (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()
);
---

<BaseLayout
  title="Timeline"
  description="A personal AI brainstorming workspace — every conversation, plan, and breakthrough traced over time."
>
  <!-- ── Full-width hero (escapes max-w-6xl via named slot) ── -->
  <div slot="hero">
    <section
      id="hero"
      class="relative z-10 min-h-screen flex flex-col items-center justify-center overflow-hidden hero-grid"
    >
      <!-- Aurora blobs (CSS-animated, no JS) -->
      <div aria-hidden="true" class="absolute inset-0 overflow-hidden pointer-events-none select-none">
        <div class="aurora-blob aurora-1"></div>
        <div class="aurora-blob aurora-2"></div>
        <div class="aurora-blob aurora-3"></div>
      </div>

      <!-- 3D neural network — fixed, covers full page (React island) -->
      <Scene3D client:only="react" />

      <!-- Radial vignette — fades aurora at edges, focuses center -->
      <div aria-hidden="true" class="absolute inset-0 hero-vignette pointer-events-none select-none"></div>

      <!-- ── Hero content ── -->
      <div class="relative z-10 flex flex-col items-center text-center gap-7 max-w-4xl mx-auto px-6 py-24">

        <!-- Eyebrow badge -->
        <div class="hero-badge inline-flex items-center gap-2.5 px-4 py-2 rounded-full border border-blue-500/30 bg-blue-500/10 backdrop-blur-sm text-sm font-mono select-none">
          <span class="hero-badge-dot w-1.5 h-1.5 rounded-full animate-pulse flex-shrink-0"></span>
          GitHub Copilot × Personal Workspace
        </div>

        <!-- Main headline -->
        <h1 class="text-5xl sm:text-6xl md:text-[5.5rem] font-bold tracking-tight leading-[0.92]">
          <span class="hero-gradient-text">AI Brainstorming</span>
          <span class="block text-foreground/90">Timeline</span>
        </h1>

        <!-- Subheading -->
        <p class="text-lg md:text-xl text-muted-foreground max-w-2xl leading-relaxed">
          A living archive of every conversation, study plan, and code session —
          <span class="text-foreground/80 font-medium">traced through time</span>.
        </p>

        <!-- Stats row -->
        <div class="flex flex-wrap items-center justify-center gap-3 mt-1">
          <!-- Chats -->
          <div class="flex items-center gap-2.5 px-4 py-2.5 rounded-2xl bg-card/70 border border-border/70 backdrop-blur-md text-sm hover:border-blue-500/30 transition-colors">
            <svg class="w-4 h-4 text-blue-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>
            <span class="font-bold text-foreground tabular-nums">{chats.length}</span>
            <span class="text-muted-foreground">Chat{chats.length !== 1 ? 's' : ''}</span>
          </div>
          <!-- Plans -->
          <div class="flex items-center gap-2.5 px-4 py-2.5 rounded-2xl bg-card/70 border border-border/70 backdrop-blur-md text-sm hover:border-purple-500/30 transition-colors">
            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
            </svg>
            <span class="font-bold text-foreground tabular-nums">{plans.length}</span>
            <span class="text-muted-foreground">Plan{plans.length !== 1 ? 's' : ''}</span>
          </div>
          <!-- Total -->
          <div class="flex items-center gap-2.5 px-4 py-2.5 rounded-2xl bg-card/70 border border-border/70 backdrop-blur-md text-sm hover:border-violet-500/30 transition-colors">
            <svg class="w-4 h-4 text-violet-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <span class="font-bold text-foreground tabular-nums">{entries.length}</span>
            <span class="text-muted-foreground">Total Sessions</span>
          </div>
        </div>

        <!-- Feature pills -->
        <div class="flex flex-wrap items-center justify-center gap-2 text-xs text-muted-foreground/70 font-mono">
          {['Auto-saved', 'Inline editing', 'Syntax highlighting', 'MCP-powered'].map((f) => (
            <span class="px-2.5 py-1 rounded-full bg-muted/50 border border-border/40">{f}</span>
          ))}
        </div>
      </div>

      <!-- Scroll indicator -->
      <a
        href="#timeline"
        class="absolute bottom-8 left-1/2 -translate-x-1/2 flex flex-col items-center gap-1.5 text-muted-foreground/50 hover:text-muted-foreground/80 transition-colors group"
        aria-label="Scroll to timeline"
      >
        <span class="text-[10px] font-mono tracking-[0.18em] uppercase">Scroll</span>
        <svg class="w-4 h-4 scroll-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      </a>
    </section>

    <!-- Section bridge gradient -->
    <div aria-hidden="true" class="h-px bg-gradient-to-r from-transparent via-blue-500/15 to-transparent"></div>
  </div>

  <!-- ── Timeline section (inside max-w-6xl default slot) ── -->
  <section id="timeline" class="relative z-10 py-20">

    <!-- Section header -->
    <div class="mb-14 flex flex-col items-center gap-3 text-center">
      <div class="flex items-center gap-4">
        <div class="h-px w-14 bg-gradient-to-r from-transparent to-border"></div>
        <span class="text-[11px] font-mono tracking-[0.22em] uppercase text-muted-foreground select-none">
          Session Log
        </span>
        <div class="h-px w-14 bg-gradient-to-l from-transparent to-border"></div>
      </div>
      <h2 class="text-3xl font-bold text-foreground">Your Journey</h2>
      <p class="text-sm text-muted-foreground">
        <span class="font-semibold tabular-nums" style="color: var(--badge-text)">{entries.length}</span>
        {' '}session{entries.length !== 1 ? 's' : ''} logged
      </p>
    </div>

    {entries.length > 0 ? (
      <TracingBeam client:visible entries={entries} />
    ) : (
      <div class="text-center py-20 text-muted-foreground">
        <p class="text-lg mb-2">No sessions yet.</p>
        <p class="text-sm">
          Run{' '}
          <code class="px-2 py-1 rounded bg-muted font-mono text-xs">
            npm run new-chat -- "My First Chat"
          </code>{' '}
          to get started.
        </p>
      </div>
    )}
  </section>
</BaseLayout>
